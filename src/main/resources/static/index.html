<!DOCTYPE html>
<html lang="zh-CN">
<meta http-equiv="pragma" content="no-cache">
<meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="expires" content="0">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>旅行规划系统 - 首页</title>
    <!-- 引入Vue3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- 引入Element Plus -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <!-- 引入Element Plus图标 -->
    <link rel="stylesheet" href="https://unpkg.com/@element-plus/icons-vue/dist/index.css">
    <script src="https://unpkg.com/@element-plus/icons-vue/dist/index.iife.min.js"></script>
    <!-- 引入axios -->
    <script src="./js/axios.min.js"></script>
    <link rel="stylesheet" href="./css/index.css">
</head>

<body>
    <div id="app">
        <div class="container">
            <!-- 顶部导航 -->
            <div class="header">
                <h1>我的旅行规划</h1>
                <div style="display: flex; gap: 10px;">
                    <el-button type="default" @click="openApiKeyDialog">
                        <el-icon>
                            <Setting />
                        </el-icon>
                        设置
                    </el-button>
                    <el-button type="primary" @click="handleCreatePlan">
                        <el-icon>
                            <plus />
                        </el-icon>
                        新建规划
                    </el-button>
                </div>
            </div>

            <!-- 规划列表 -->
            <div v-if="loading" class="loading-container">
                <el-skeleton :rows="3" animated />
            </div>
            <div v-else-if="plans.length > 0" class="plans-list">
                <el-card v-for="plan in plans" :key="plan.id" class="plan-card mb-4 cursor-pointer"
                    @click="goToDetail(plan.id)">
                    <template #header>
                        <div class="card-header">
                            <span class="text-xl font-bold">{{ plan.title }}</span>
                        </div>
                    </template>
                    <div class="card-body">
                        <div class="plan-info mb-3">
                            <span class="plan-date">
                                {{ formatDate(plan.startDate) }} - {{ formatDate(plan.endDate) }}
                            </span>
                            <span class="plan-destination">{{ plan.destination }}</span>
                        </div>
                        <div class="plan-meta">
                            <el-tag size="small">{{ plan.peopleCount }}人</el-tag>
                            <el-tag size="small" type="info" v-if="plan.budget > 0">
                                预算: ¥{{ plan.budget }}
                            </el-tag>
                            <el-tag size="small" :type="getStatusType(plan.status)">
                                {{ getStatusText(plan.status) }}
                            </el-tag>
                        </div>
                    </div>
                    <template #footer>
                        <div class="card-footer"
                            style="display: flex; justify-content: space-between; align-items: center;">
                            <span class="text-sm text-gray-500">
                                创建时间: {{ formatDateTime(plan.createdAt) }}
                            </span>
                            <el-button type="danger" size="small" @click="deletePlan(plan.id,$event)">
                                <el-icon>
                                    <Delete />
                                </el-icon>
                                删除
                            </el-button>
                        </div>
                    </template>
                </el-card>
            </div>
            <div v-else class="no-plans">
                <el-empty description="暂无旅行规划" />
                <el-button type="primary" class="mt-4" @click="showCreatePlanDialog = true">
                    <el-icon>
                        <plus />
                    </el-icon>
                    立即创建
                </el-button>
            </div>
        </div>

        <!-- 新建规划弹窗 -->
        <el-dialog v-model="showCreatePlanDialog" title="新建旅行规划" width="50%">
            <el-tabs v-model="activeTab" type="border-card">
                <el-tab-pane label="语音输入" name="voice">
                    <div class="voice-input-container">
                        <el-input v-model="voiceInput" type="textarea" placeholder="语音识别结果将显示在这里，您可以编辑后提交" :rows="8"
                            style="margin-bottom: 16px;">
                        </el-input>
                        <div style="text-align: center;">
                            <el-button type="primary" @click="toggleRecording" :icon="recording ? 'Stop' : 'Microphone'"
                                size="large">
                                {{ recording ? '停止录音' : '开始录音' }}
                            </el-button>
                        </div>
                    </div>
                </el-tab-pane>
                <el-tab-pane label="表单填写" name="form">
                    <el-form ref="createPlanForm" :model="createPlanForm" label-width="100px">
                        <el-form-item label="规划标题" prop="title" required>
                            <el-input v-model="createPlanForm.title" placeholder="请输入规划标题" />
                        </el-form-item>
                        <el-form-item label="目的地" prop="destination" required>
                            <el-input v-model="createPlanForm.destination" placeholder="请输入目的地" />
                        </el-form-item>
                        <el-form-item label="开始日期" prop="startDate" required>
                            <el-date-picker v-model="createPlanForm.startDate" type="date" placeholder="选择开始日期"
                                style="width: 100%" />
                        </el-form-item>
                        <el-form-item label="结束日期" prop="endDate" required>
                            <el-date-picker v-model="createPlanForm.endDate" type="date" placeholder="选择结束日期"
                                style="width: 100%" />
                        </el-form-item>
                        <el-form-item label="同行人数" prop="peopleCount">
                            <el-input-number v-model="createPlanForm.peopleCount" :min="1" :max="20" />
                        </el-form-item>
                        <el-form-item label="预算金额" prop="budget">
                            <el-input-number v-model="createPlanForm.budget" :min="0" :step="100" />
                        </el-form-item>
                        <el-form-item label="旅行偏好" prop="preferences">
                            <el-input v-model="createPlanForm.preferences" type="textarea"
                                placeholder="请输入旅行偏好，如：喜欢美食、历史文化、自然风光等" :rows="3" />
                        </el-form-item>
                    </el-form>
                </el-tab-pane>
            </el-tabs>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="showCreatePlanDialog = false">取消</el-button>
                    <el-button type="primary" @click="submitPlan"
                        :disabled="creatingPlan || (activeTab === 'voice' && !voiceInput)">
                        {{ activeTab === 'form' ? '创建计划' : '生成计划' }}
                    </el-button>
                </span>
            </template>
        </el-dialog>

        <!-- API Key输入弹窗 -->
        <el-dialog v-model="showApiKeyDialog" title="设置阿里云百炼API Key" width="50%">
            <el-form ref="apiKeyForm" :model="apiKeyForm" label-width="150px">
                <el-form-item label="API Key" prop="apiKey" required>
                    <el-input v-model="apiKeyForm.apiKey" placeholder="请输入您的阿里云百炼API Key" type="password" />
                    <el-input__suffix>
                        <el-button @click="toggleApiKeyVisibility" size="small">
                            {{ showApiKey ? '隐藏' : '显示' }}
                        </el-button>
                    </el-input__suffix>
                </el-form-item>
            </el-form>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="showApiKeyDialog = false">取消</el-button>
                    <el-button type="primary" @click="saveApiKey">保存</el-button>
                </span>
            </template>
        </el-dialog>
    </div>

    <script type="module">
        import { getTravelPlans, createTravelPlan, deleteTravelPlan, redirectWithToken, createTravelPlanByQuery } from './js/api-1.0.js';
        const { createApp } = Vue
        const { ElMessage, ElLoading, ElMessageBox } = ElementPlus

        const app = createApp({
            data() {
                return {
                    loading: false,
                    plans: [],
                    showCreatePlanDialog: false,
                    // API Key输入弹窗
                    showApiKeyDialog: false,
                    apiKey: '',
                    // API Key表单
                    apiKeyForm: {
                        apiKey: ''
                    },
                    // API Key可见状态
                    showApiKey: false,
                    // 新建规划标签页
                    activeTab: 'voice',
                    // 语音输入内容
                    voiceInput: '',
                    // 录音状态
                    recording: false,
                    // 语音识别实例
                    speechRecognition: null,
                    creatingPlan: false,
                    createPlanForm: {
                        title: '',
                        destination: '',
                        startDate: '',
                        endDate: '',
                        peopleCount: 1,
                        budget: 0,
                        preferences: ''
                    }
                }
            },
            mounted() {
                // 页面加载时获取用户规划列表
                this.fetchPlans()
                // 检查是否已有API Key，如果没有则弹出输入框
                this.checkApiKey()
            },
            methods: {
                // 检查API Key
                checkApiKey() {
                    // 检查localStorage中是否已有API Key
                    const savedApiKey = localStorage.getItem('apiKey')
                    if (savedApiKey) {
                        this.apiKey = savedApiKey
                        this.apiKeyForm.apiKey = savedApiKey
                    } else {
                        // 如果没有则弹出输入框
                        this.showApiKeyDialog = true
                    }
                },

                // 打开API Key设置对话框
                openApiKeyDialog() {
                    // 将当前apiKey赋值给表单
                    this.apiKeyForm.apiKey = this.apiKey;
                    // 显示对话框
                    this.showApiKeyDialog = true;
                },

                // 切换API Key可见性
                toggleApiKeyVisibility() {
                    this.showApiKey = !this.showApiKey
                    // 延迟修改input类型以确保DOM已更新
                    setTimeout(() => {
                        const input = document.querySelector('.api-key-input input')
                        if (input) {
                            input.type = this.showApiKey ? 'text' : 'password'
                        }
                    }, 0)
                },

                // 保存API Key
                saveApiKey() {
                    if (!this.apiKeyForm.apiKey) {
                        ElMessage.warning('请输入API Key')
                        return
                    }
                    // 保存到localStorage
                    localStorage.setItem('apiKey', this.apiKeyForm.apiKey)
                    this.apiKey = this.apiKeyForm.apiKey
                    this.showApiKeyDialog = false
                    ElMessage.success('API Key保存成功')
                },

                // 获取用户规划列表
                handleCreatePlan() {
                    const apiKey = localStorage.getItem('apiKey')
                    if (!apiKey) {
                        this.showApiKeyDialog = true
                    } else {
                        this.showCreatePlanDialog = true
                    }
                },

                fetchPlans() {
                    this.loading = true
                    getTravelPlans()
                        .then(data => this.plans = data)
                        .finally(() => this.loading = false)
                },

                // 跳转到规划详情页，先验证token有效性
                goToDetail(planId) {
                    redirectWithToken(`detail.html?id=${planId}`);
                },

                // 初始化语音识别
                initSpeechRecognition() {
                    // 检查浏览器是否支持Web Audio API和WebSocket
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        ElMessage.warning('您的浏览器不支持音频采集功能');
                        return;
                    }
                    
                    if (!window.WebSocket) {
                        ElMessage.warning('您的浏览器不支持WebSocket功能');
                        return;
                    }
                    
                    // 初始化音频上下文和WebSocket连接
                    console.log('初始化语音识别');
                    try {
                        // 直接创建音频上下文而不是设置为null
                        this.audioContext = new (window.AudioContext || window.webkitAudioContext)({
                            sampleRate: 16000  // 讯飞API要求16kHz采样率
                        });
                    } catch (e) {
                        console.error('创建音频上下文失败:', e);
                        ElMessage.error('无法创建音频上下文');
                        return;
                    }
                    
                    this.mediaStream = null;
                    this.processor = null;
                    this.websocket = null;
                    this.recognitionBuffer = [];
                },

                // 切换录音状态
                async toggleRecording() {
                    if (!this.audioContext) {
                        this.initSpeechRecognition();
                        if (!this.audioContext) return;
                    }
                    console.log('切换录音状态');
                    if (this.recording) {
                        this.stopRecording();
                        console.log('录音已停止');
                    } else {
                        console.log('录音正在启动');
                        await this.startRecording();
                    }
                },
                
                // 开始录音
                async startRecording() {
                    try {
                        // 清除之前的内容
                        this.voiceInput = '';
                        this.recognitionBuffer = [];
                        
                        // 获取用户媒体
                        this.mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        
                        // 检查音频上下文是否已暂停，如果是则恢复
                        if (this.audioContext.state === 'suspended') {
                            await this.audioContext.resume();
                        }
                        
                        // 创建媒体流源
                        const source = this.audioContext.createMediaStreamSource(this.mediaStream);
                        
                        // 创建脚本处理器
                        this.processor = this.audioContext.createScriptProcessor(4096, 1, 1);
                        
                        // 连接音频处理链
                        source.connect(this.processor);
                        this.processor.connect(this.audioContext.destination);
                        
                        // 处理音频数据
                        this.processor.onaudioprocess = (event) => {
                            const inputData = event.inputBuffer.getChannelData(0);
                            // 转换为16位PCM格式
                            const pcmData = this.floatTo16BitPCM(inputData);
                            // 发送音频数据到WebSocket
                            if (this.websocket && this.websocket.readyState === WebSocket.OPEN) {
                                this.websocket.send(pcmData);
                            }
                        };
                        
                        // 建立WebSocket连接
                        this.connectWebSocket();
                        
                        this.recording = true;
                        console.log('录音已开始');
                        ElMessage.success('开始录音，请说出您的旅行计划...');
                    } catch (error) {
                        console.error('录音启动失败:', error);
                        ElMessage.error('无法访问麦克风，请检查权限设置');
                    }
                },
                
                // 停止录音
                stopRecording() {
                    // 发送结束标志
                    if (this.websocket && this.websocket.readyState === WebSocket.OPEN) {
                        this.websocket.send(JSON.stringify({ type: 'end' }));
                    }
                    
                    // 停止音频处理
                    if (this.processor) {
                        this.processor.disconnect();
                        this.processor = null;
                    }
                    
                    // 关闭媒体流
                    if (this.mediaStream) {
                        this.mediaStream.getTracks().forEach(track => track.stop());
                        this.mediaStream = null;
                    }
                    
                    // 关闭音频上下文
                    if (this.audioContext) {
                        this.audioContext.close();
                        this.audioContext = null;
                    }
                    
                    this.recording = false;
                    ElMessage.success('录音已停止，正在识别...');
                },
                
                // 连接WebSocket
                connectWebSocket() {
                    // 获取当前用户的token
                    const token = localStorage.getItem('token');
                    if (!token) {
                        ElMessage.error('请先登录');
                        return;
                    }
                    
                    // 构建WebSocket URL，包含token作为查询参数
                    const wsUrl = `ws://localhost:8080/ws/speech?token=${token}`;
                    
                    // 创建WebSocket连接
                    this.websocket = new WebSocket(wsUrl);
                    
                    // 连接打开时发送开始标志
                    this.websocket.onopen = () => {
                        this.websocket.send(JSON.stringify({ type: 'start' }));
                    };
                    
                    // 接收消息
                    this.websocket.onmessage = (event) => {
                        const message = JSON.parse(event.data);
                        
                        if (message.type === 'result') {
                            // 更新语音输入内容
                            this.voiceInput = message.text;
                        } else if (message.type === 'error') {
                            console.error('语音识别错误:', message.message);
                            ElMessage.error(`语音识别错误: ${message.message}`);
                            this.stopRecording();
                        }
                    };
                    
                    // 连接关闭
                    this.websocket.onclose = () => {
                        console.log('WebSocket连接已关闭');
                        this.websocket = null;
                    };
                    
                    // 连接错误
                    this.websocket.onerror = (error) => {
                        console.error('WebSocket错误:', error);
                        ElMessage.error('语音识别服务连接失败');
                        this.stopRecording();
                    };
                },
                
                // 将浮点音频数据转换为16位PCM
                floatTo16BitPCM(input) {
                    const output = new Int16Array(input.length);
                    for (let i = 0; i < input.length; i++) {
                        const s = Math.max(-1, Math.min(1, input[i]));
                        output[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                    }
                    return output.buffer;
                },

                // 提交计划
                submitPlan() {
                    if (this.activeTab === 'form') {
                        this.createPlan();
                    } else {
                        this.generatePlanFromVoice();
                    }
                },

                // 创建新规划
                createPlan() {
                    // 表单验证
                    if (!this.createPlanForm.title || !this.createPlanForm.destination) {
                        ElMessage.warning('请填写必填项');
                        return;
                    }

                    if (this.createPlanForm.startDate && this.createPlanForm.endDate &&
                        new Date(this.createPlanForm.startDate) > new Date(this.createPlanForm.endDate)) {
                        ElMessage.warning('开始日期不能晚于结束日期');
                        return;
                    }

                    this.creatingPlan = true; // 禁用按钮

                    // 创建全屏加载动画
                    const loading = ElLoading.service({
                        lock: true,
                        text: '正在生成旅行计划，请稍候...',
                        background: 'rgba(0, 0, 0, 0.7)'
                    });

                    createTravelPlan(this.createPlanForm).then(data => {
                        ElMessage.success('创建规划成功');
                        // 刷新规划列表
                        this.fetchPlans();
                        // 跳转到新建规划的详情页
                        this.goToDetail(data.id);
                    }).catch(err => {
                        ElMessage.error(err.response?.data?.message || '生成计划失败');
                    }).finally(() => {
                        loading.close();
                        this.showCreatePlanDialog = false;
                        this.creatingPlan = false;
                    })
                },

                // 根据语音输入生成计划
                generatePlanFromVoice() {
                    this.creatingPlan = true;

                    // 创建全屏加载动画
                    const loading = ElLoading.service({
                        lock: true,
                        text: '正在解析语音输入并生成计划...',
                        background: 'rgba(0, 0, 0, 0.7)'
                    });

                    // 创建请求数据
                    const requestData = {
                        query: this.voiceInput
                    };

                    createTravelPlanByQuery(requestData).then(data => {
                        ElMessage.success('创建规划成功');
                        // 刷新规划列表
                        this.fetchPlans();
                        // 跳转到新建规划的详情页
                        this.goToDetail(data.id);
                    }).catch(err => {
                        console.error('生成计划失败:', err);
                        ElMessage.error(err.response?.data?.message || err.message || '生成计划失败');
                    }).finally(() => {
                        loading.close();
                        this.showCreatePlanDialog = false;
                        this.creatingPlan = false;
                    })
                },

                // 格式化日期
                formatDate(dateString) {
                    if (!dateString) return ''
                    const date = new Date(dateString)
                    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`
                },

                // 格式化日期时间
                formatDateTime(dateTimeString) {
                    if (!dateTimeString) return ''
                    const date = new Date(dateTimeString)
                    return `${this.formatDate(dateTimeString)} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`
                },

                // 获取状态样式
                getStatusType(status) {
                    const statusMap = {
                        'draft': 'warning',
                        'published': 'success',
                        'archived': 'info'
                    }
                    return statusMap[status] || 'default'
                },

                // 获取状态文本
                getStatusText(status) {
                    const statusMap = {
                        'draft': '草稿',
                        'published': '已发布',
                        'archived': '已归档'
                    }
                    return statusMap[status] || status
                },

                // 删除规划
                deletePlan(planId, event) {
                    // 阻止事件冒泡，避免触发卡片的点击事件
                    event.stopPropagation()
                    ElMessageBox.confirm('确定要删除这个规划吗?', '提示', {
                        type: 'warning',
                        confirmButtonText: '确定',
                        cancelButtonText: '取消'
                    }).then(() => {
                        return deleteTravelPlan(planId)
                    }).then(() => {
                        ElMessage.success('删除规划成功')
                        // 从本地列表中移除该规划
                        this.plans = this.plans.filter(plan => plan.id !== planId)
                    })
                }
            }
        })
        // 注册Element Plus图标
        for (const iconName in ElementPlusIconsVue) {
            app.component(iconName, ElementPlusIconsVue[iconName])
        }
        app.use(ElementPlus).mount('#app')
    </script>
</body>

</html>