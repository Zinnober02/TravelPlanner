<!DOCTYPE html>
<html lang="zh-CN">
<meta http-equiv="pragma" content="no-cache">
<meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="expires" content="0">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>旅行规划系统 - 首页</title>
    <!-- 引入Vue3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- 引入Element Plus -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <!-- 引入Element Plus图标 -->
    <link rel="stylesheet" href="https://unpkg.com/@element-plus/icons-vue/dist/index.css">
    <script src="https://unpkg.com/@element-plus/icons-vue/dist/index.iife.min.js"></script>
    <!-- 引入axios -->
    <script src="./js/axios.min.js"></script>
    <link rel="stylesheet" href="./css/index.css">
</head>

<body>
    <div id="app">
        <div class="container">
            <!-- 顶部导航 -->
            <div class="header">
                <h1>我的旅行规划</h1>
                <el-button type="primary" @click="showCreatePlanDialog = true">
                    <el-icon>
                        <plus />
                    </el-icon>
                    新建规划
                </el-button>
            </div>

            <!-- 规划列表 -->
            <div v-if="loading" class="loading-container">
                <el-skeleton :rows="3" animated />
            </div>
            <div v-else-if="plans.length > 0" class="plans-list">
                <el-card v-for="plan in plans" :key="plan.id" class="plan-card mb-4 cursor-pointer"
                    @click="goToDetail(plan.id)">
                    <template #header>
                        <div class="card-header">
                            <span class="text-xl font-bold">{{ plan.title }}</span>
                        </div>
                    </template>
                    <div class="card-body">
                        <div class="plan-info mb-3">
                            <span class="plan-date">
                                {{ formatDate(plan.startDate) }} - {{ formatDate(plan.endDate) }}
                            </span>
                            <span class="plan-destination">{{ plan.destination }}</span>
                        </div>
                        <div class="plan-meta">
                            <el-tag size="small">{{ plan.peopleCount }}人</el-tag>
                            <el-tag size="small" type="info" v-if="plan.budget > 0">
                                预算: ¥{{ plan.budget }}
                            </el-tag>
                            <el-tag size="small" :type="getStatusType(plan.status)">
                                {{ getStatusText(plan.status) }}
                            </el-tag>
                        </div>
                    </div>
                    <template #footer>
                        <div class="card-footer"
                            style="display: flex; justify-content: space-between; align-items: center;">
                            <span class="text-sm text-gray-500">
                                创建时间: {{ formatDateTime(plan.createdAt) }}
                            </span>
                            <el-button type="danger" size="small" @click="deletePlan(plan.id,$event)">
                                <el-icon>
                                    <Delete />
                                </el-icon>
                                删除
                            </el-button>
                        </div>
                    </template>
                </el-card>
            </div>
            <div v-else class="no-plans">
                <el-empty description="暂无旅行规划" />
                <el-button type="primary" class="mt-4" @click="showCreatePlanDialog = true">
                    <el-icon>
                        <plus />
                    </el-icon>
                    立即创建
                </el-button>
            </div>
        </div>

        <!-- 新建规划弹窗 -->
        <el-dialog v-model="showCreatePlanDialog" title="新建旅行规划" width="50%">
            <el-form ref="createPlanForm" :model="createPlanForm" label-width="100px">
                <el-form-item label="规划标题" prop="title" required>
                    <el-input v-model="createPlanForm.title" placeholder="请输入规划标题" />
                </el-form-item>
                <el-form-item label="目的地" prop="destination" required>
                    <el-input v-model="createPlanForm.destination" placeholder="请输入目的地" />
                </el-form-item>
                <el-form-item label="开始日期" prop="startDate" required>
                    <el-date-picker v-model="createPlanForm.startDate" type="date" placeholder="选择开始日期"
                        style="width: 100%" />
                </el-form-item>
                <el-form-item label="结束日期" prop="endDate" required>
                    <el-date-picker v-model="createPlanForm.endDate" type="date" placeholder="选择结束日期"
                        style="width: 100%" />
                </el-form-item>
                <el-form-item label="同行人数" prop="peopleCount">
                    <el-input-number v-model="createPlanForm.peopleCount" :min="1" :max="20" />
                </el-form-item>
                <el-form-item label="预算金额" prop="budget">
                    <el-input-number v-model="createPlanForm.budget" :min="0" :step="100" />
                </el-form-item>
                <el-form-item label="旅行偏好" prop="preferences">
                    <el-input v-model="createPlanForm.preferences" type="textarea"
                        placeholder="请输入旅行偏好，如：喜欢美食、历史文化、自然风光等" :rows="3" />
                </el-form-item>
            </el-form>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="showCreatePlanDialog = false">取消</el-button>
                    <el-button type="primary" @click="createPlan" :disabled="creatingPlan">确定</el-button>
                </span>
            </template>
        </el-dialog>
    </div>

    <script type="module">
        import { getTravelPlans, createTravelPlan, deleteTravelPlan, redirectWithToken } from './js/api-1.0.js';
        const { createApp } = Vue
        const { ElMessage, ElLoading, ElMessageBox } = ElementPlus

        const app = createApp({
            data() {
                return {
                    loading: false,
                    plans: [],
                    showCreatePlanDialog: false,
                    creatingPlan: false,
                    createPlanForm: {
                        title: '',
                        destination: '',
                        startDate: '',
                        endDate: '',
                        peopleCount: 1,
                        budget: 0,
                        preferences: ''
                    }
                }
            },
            mounted() {
                // 页面加载时获取用户规划列表
                this.fetchPlans()
            },
            methods: {
                // 获取用户规划列表
                async fetchPlans() {
                    this.loading = true
                    getTravelPlans()
                        .then(data => this.plans = data)
                        .finally(() => this.loading = false)
                },


                // 跳转到规划详情页，先验证token有效性
                goToDetail(planId) {
                    redirectWithToken(`detail.html?id=${planId}`);
                },

                // 创建新规划
                createPlan() {
                    // 表单验证
                    if (!this.createPlanForm.title || !this.createPlanForm.destination) {
                        ElMessage.warning('请填写必填项');
                        return;
                    }

                    if (this.createPlanForm.startDate && this.createPlanForm.endDate &&
                        new Date(this.createPlanForm.startDate) > new Date(this.createPlanForm.endDate)) {
                        ElMessage.warning('开始日期不能晚于结束日期');
                        return;
                    }

                    this.creatingPlan = true; // 禁用按钮

                    // 创建全屏加载动画
                    const loading = ElLoading.service({
                        lock: true,
                        text: '正在生成旅行计划，请稍候...',
                        background: 'rgba(0, 0, 0, 0.7)'
                    });

                    createTravelPlan(this.createPlanForm).then(data => {
                        ElMessage.success('创建规划成功');
                        // 刷新规划列表
                        this.fetchPlans();
                        // 跳转到新建规划的详情页
                        this.goToDetail(data.id);
                    }).finally(() => {
                        loading.close();
                        this.showCreatePlanDialog = false;
                        this.creatingPlan = false;
                    })
                },

                // 格式化日期
                formatDate(dateString) {
                    if (!dateString) return ''
                    const date = new Date(dateString)
                    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`
                },

                // 格式化日期时间
                formatDateTime(dateTimeString) {
                    if (!dateTimeString) return ''
                    const date = new Date(dateTimeString)
                    return `${this.formatDate(dateTimeString)} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`
                },

                // 获取状态样式
                getStatusType(status) {
                    const statusMap = {
                        'draft': 'warning',
                        'published': 'success',
                        'archived': 'info'
                    }
                    return statusMap[status] || 'default'
                },

                // 获取状态文本
                getStatusText(status) {
                    const statusMap = {
                        'draft': '草稿',
                        'published': '已发布',
                        'archived': '已归档'
                    }
                    return statusMap[status] || status
                },

                // 删除规划
                deletePlan(planId, event) {
                    // 阻止事件冒泡，避免触发卡片的点击事件
                    event.stopPropagation()
                    ElMessageBox.confirm('确定要删除这个规划吗?', '提示', {
                        type: 'warning',
                        confirmButtonText: '确定',
                        cancelButtonText: '取消'
                    }).then(() => {
                        return deleteTravelPlan(planId)
                    }).then(() => {
                        ElMessage.success('删除规划成功')
                        // 从本地列表中移除该规划
                        this.plans = this.plans.filter(plan => plan.id !== planId)
                    })
                }
            }
        })
        // 注册Element Plus图标
        for (const iconName in ElementPlusIconsVue) {
            app.component(iconName, ElementPlusIconsVue[iconName])
        }
        app.use(ElementPlus).mount('#app')
    </script>
</body>

</html>