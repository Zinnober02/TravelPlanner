<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>旅行规划详情</title>
    <!-- 引入Vue3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- 引入Element Plus -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <!-- 引入Element Plus图标 -->
    <link rel="stylesheet" href="https://unpkg.com/@element-plus/icons-vue/dist/index.css">
    <!-- 引入axios -->
    <script src="./js/axios.min.js"></script>
    <link rel="stylesheet" href="./css/index.css">
</head>

<body>
    <div id="app">
        <div class="container">
            <!-- 顶部导航 -->
            <div class="header">
                <div>
                    <el-button type="primary" @click="goBack">
                        <el-icon><arrow-left /></el-icon>
                        返回列表
                    </el-button>
                    <el-button type="warning" @click="editPlan" :disabled="plan.status === 'archived'">
                        <el-icon>
                            <edit />
                        </el-icon>
                        编辑
                    </el-button>
                    <el-button type="danger" @click="deletePlan">
                        <el-icon>
                            <delete />
                        </el-icon>
                        删除
                    </el-button>
                </div>
            </div>

            <!-- 规划详情 -->
            <div v-if="loading" class="loading-container">
                <el-skeleton :rows="6" animated />
            </div>
            <div v-else-if="plan" class="plan-content">
                <!-- 规划基本信息 -->
                <div class="plan-info">
                    <div class="plan-header">
                        <h1 class="plan-title">{{ plan.title }}</h1>
                        <el-tag :type="getStatusType(plan.status)">
                            {{ getStatusText(plan.status) }}
                        </el-tag>
                    </div>

                    <div class="plan-meta">
                        <el-tag size="large" type="success">{{ plan.destination }}</el-tag>
                        <el-tag size="large">{{ formatDate(plan.startDate) }} - {{ formatDate(plan.endDate) }}</el-tag>
                        <el-tag size="large">{{ plan.peopleCount }}人</el-tag>
                        <el-tag size="large" type="info" v-if="plan.budget > 0">预算: ¥{{ plan.budget }}</el-tag>
                    </div>

                    <div v-if="plan.preferences" class="plan-preferences">
                        <h3>旅行偏好</h3>
                        <p>{{ plan.preferences }}</p>
                    </div>
                </div>

                <!-- 行程安排 -->
                <div class="itinerary-section">
                    <h2>行程安排</h2>
                    <div v-if="itinerary && itinerary.plan && itinerary.plan.days" class="days-container">
                        <div v-for="day in itinerary.plan.days" :key="day.day" class="day-section">
                            <h3>{{ day.day }}. {{ day.day === 1 ? '抵达与探索' : '行程安排' }}</h3>
                            <div v-for="(activity, index) in day.schedule" :key="index" class="activity-item">
                                <div class="activity-time">{{ activity.time }}</div>
                                <div class="activity-title">
                                    <span>{{ activity.activity }}</span>
                                    <el-tag size="small" type="primary" class="ml-2">{{ activity.location }}</el-tag>
                                </div>
                                <div class="activity-description">{{ activity.description }}</div>
                                <div class="activity-description">{{ activity.cost }}</div>
                            </div>
                        </div>
                    </div>
                    <div v-else-if="!loading" class="no-itinerary">
                        <el-empty description="暂无行程安排" />
                        <el-button type="primary" class="mt-4" @click="fetchPlanDetail">重新生成行程</el-button>
                    </div>
                </div>
            </div>
            <div v-else class="no-plan">
                <el-empty description="未找到规划信息" />
                <el-button type="primary" class="mt-4" @click="goBack">返回列表</el-button>
            </div>
        </div>
        <!-- 编辑表单对话框 -->
        <el-dialog title="编辑旅行规划" v-model="editDialogVisible" width="700px">
            <el-form :model="editForm" :rules="editRules" ref="editFormRef" label-width="120px">
                <el-form-item label="标题" prop="title">
                    <el-input v-model="editForm.title" placeholder="请输入标题" />
                </el-form-item>
                <el-form-item label="目的地" prop="destination">
                    <el-input v-model="editForm.destination" placeholder="请输入目的地" />
                </el-form-item>
                <el-form-item label="开始日期" prop="startDate">
                    <el-date-picker v-model="editForm.startDate" type="date" placeholder="选择开始日期" style="width: 100%" />
                </el-form-item>
                <el-form-item label="结束日期" prop="endDate">
                    <el-date-picker v-model="editForm.endDate" type="date" placeholder="选择结束日期" style="width: 100%" />
                </el-form-item>
                <el-form-item label="人数" prop="peopleCount">
                    <el-input-number v-model="editForm.peopleCount" :min="1" :step="1" placeholder="请输入人数" />
                </el-form-item>
                <el-form-item label="预算">
                    <el-input-number v-model="editForm.budget" :min="0" :step="100" placeholder="请输入预算" />
                </el-form-item>
                <el-form-item label="旅行偏好">
                    <el-input v-model="editForm.preferences" type="textarea" rows="4" placeholder="请输入旅行偏好" />
                </el-form-item>
                <el-form-item label="状态">
                    <el-select v-model="editForm.status" placeholder="选择状态">
                        <el-option label="草稿" value="draft" />
                        <el-option label="已发布" value="published" />
                        <el-option label="已归档" value="archived" />
                    </el-select>
                </el-form-item>
            </el-form>
            <template #footer>
                <div class="dialog-footer">
                    <el-button @click="editDialogVisible = false">取消</el-button>
                    <el-button type="primary" @click="saveEdit">保存</el-button>
                </div>
            </template>
        </el-dialog>

        <!-- 删除确认对话框 -->
        <el-dialog title="删除确认" v-model="deleteDialogVisible" width="400px">
            <div>确定要删除此旅行规划吗？此操作不可恢复。</div>
            <template #footer>
                <div class="dialog-footer">
                    <el-button @click="deleteDialogVisible = false">取消</el-button>
                    <el-button type="danger" @click="confirmDelete">确定</el-button>
                </div>
            </template>
        </el-dialog>
    </div>

    <script type="module">
        import { getTravelPlanById, updateTravelPlan, deleteTravelPlan, redirectWithToken } from './js/api.js';

        const { createApp } = Vue
        const { ElMessage, ElLoading } = ElementPlus

        createApp({
            data() {
                return {
                    loading: false,
                    planId: '',
                    plan: null,
                    itinerary: null, // 添加行程数据字段
                    editDialogVisible: false,
                    editForm: {},
                    editRules: {
                        title: [
                            { required: true, message: '请输入标题', trigger: 'blur' }
                        ],
                        destination: [
                            { required: true, message: '请输入目的地', trigger: 'blur' }
                        ],
                        startDate: [
                            { required: true, message: '请选择开始日期', trigger: 'change' }
                        ],
                        endDate: [
                            { required: true, message: '请选择结束日期', trigger: 'change' }
                        ],
                        peopleCount: [
                            { required: true, message: '请输入人数', trigger: 'change' }
                        ]
                    },
                    deleteDialogVisible: false
                }
            },
            mounted() {
                // 获取URL中的规划ID
                this.planId = new URLSearchParams(window.location.search).get('id')
                if (this.planId) {
                    this.fetchPlanDetail()
                }
            },
            methods: {
                // 编辑规划
                editPlan() {
                    if (this.plan.status === 'archived') {
                        ElMessage.warning('已归档的旅行计划无法修改');
                        return;
                    }
                    // 填充表单数据
                    this.editForm = Object.assign({}, this.plan);
                    // 转换日期格式
                    this.editForm.startDate = new Date(this.editForm.startDate);
                    this.editForm.endDate = new Date(this.editForm.endDate);
                    this.editDialogVisible = true;
                },
                // 保存编辑
                async saveEdit() {
                    // 表单验证
                    const formRef = this.$refs.editFormRef;
                    if (!formRef) return;

                    // 检查是否有实际字段变化
                    const hasChanges = this.checkFormChanges();
                    if (!hasChanges) {
                        ElMessage.info('没有任何字段变化，无需更新');
                        this.editDialogVisible = false;
                        return;
                    }

                    try {
                        await formRef.validate();

                        const loading = ElLoading.service({
                            lock: true,
                            text: '正在更新旅行计划，请稍候...',
                            background: 'rgba(0, 0, 0, 0.7)'
                        });

                        // 发送更新请求
                        const response = await updateTravelPlan(this.editForm);

                        loading.close();

                        if (response.data.code !== 0) {
                            ElMessage.error(response.data.message || '更新失败');
                            return;
                        }

                        ElMessage.success('更新成功');
                        this.editDialogVisible = false;
                        // 重新获取规划详情
                        this.fetchPlanDetail();
                    } catch (error) {
                        console.error('保存失败:', error);
                        if (error.response?.status === 401) {
                            ElMessage.error('登录已过期，请重新登录');
                            localStorage.removeItem('token');
                            window.location.href = 'login.html';
                        } else {
                            ElMessage.error('保存失败，请稍后重试');
                        }
                    }
                },

                // 删除规划
                deletePlan() {
                    this.deleteDialogVisible = true;
                },
                // 确认删除
                confirmDelete() {
                    this.loading = true;
                    deleteTravelPlan(this.planId)
                        .then(() => {
                            ElMessage.success('删除成功');
                            this.goBack();
                        })
                        .finally(() => {
                            this.loading = false;
                            this.deleteDialogVisible = false;
                        });
                },
                // 获取规划详情
                fetchPlanDetail() {
                    this.loading = true;
                    getTravelPlanById(this.planId)
                        .then(data => {
                            this.plan = data;
                            this.itinerary = this.parsePlanJson(data?.planJson);
                        })
                        .finally(() => this.loading = false);
                },

                parsePlanJson(planJson) {
                    if (!planJson) return null;
                    try {
                        return JSON.parse(planJson);
                    } catch (error) {
                        console.error('解析行程数据失败:', error);
                        ElMessage.warning('行程数据解析失败');
                        return null;
                    }
                },


                // 返回列表页
                goBack() {
                    redirectWithToken('index.html');
                },

                // 检查表单是否有实际变化
                checkFormChanges() {
                    // 比较表单字段与原字段是否有变化
                    return JSON.stringify(this.editForm) !== JSON.stringify({
                        ...this.plan,
                        startDate: new Date(this.plan.startDate),
                        endDate: new Date(this.plan.endDate)
                    });
                },

                // 格式化日期
                formatDate(dateString) {
                    if (!dateString) return ''
                    const date = new Date(dateString)
                    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`
                },

                // 获取状态样式
                getStatusType(status) {
                    const statusMap = {
                        'draft': 'warning',
                        'published': 'success',
                        'archived': 'info'
                    }
                    return statusMap[status] || 'default'
                },

                // 获取状态文本
                getStatusText(status) {
                    const statusMap = {
                        'draft': '草稿',
                        'published': '已发布',
                        'archived': '已归档'
                    }
                    return statusMap[status] || status
                }
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>

</html>