# 旅游规划系统 - 数据库设计文档

## 一、数据库概述

本系统使用Supabase云数据库，采用PostgreSQL作为底层数据库引擎。由于需求中指定通过RESTful API进行数据访问，因此数据库表的设计需要考虑RESTful API的最佳实践。

## 二、表结构设计

### 2.1 用户表（users）

**表名**: users

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `UUID` | `PRIMARY KEY DEFAULT gen_random_uuid()` | 用户ID |
| `username` | `VARCHAR(50)` | `UNIQUE NOT NULL` | 用户名 |
| `password` | `VARCHAR(255)` | `NOT NULL` | 加密后的密码 |
| `email` | `VARCHAR(100)` | `UNIQUE NOT NULL` | 邮箱 |
| `phone` | `VARCHAR(20)` | `NULL` | 手机号 |
| `created_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 更新时间 |

### 2.2 旅行计划表（travel_plans）

**表名**: travel_plans

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `UUID` | `PRIMARY KEY DEFAULT gen_random_uuid()` | 计划ID |
| `user_id` | `UUID` | `REFERENCES users(id) NOT NULL` | 所属用户ID |
| `title` | `VARCHAR(100)` | `NOT NULL` | 计划标题 |
| `destination` | `VARCHAR(100)` | `NOT NULL` | 目的地 |
| `start_date` | `DATE` | `NOT NULL` | 开始日期 |
| `end_date` | `DATE` | `NOT NULL` | 结束日期 |
| `budget` | `DECIMAL(10,2)` | `DEFAULT 0` | 预算金额 |
| `people_count` | `INTEGER` | `DEFAULT 1` | 同行人数 |
| `preferences` | `TEXT` | `NULL` | 旅行偏好（JSON格式存储） |
| `plan_json` | `TEXT` | `NULL` | AI生成的完整行程JSON |
| `status` | `VARCHAR(20)` | `DEFAULT 'draft'` | 状态（draft/published/archived） |
| `created_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 更新时间 |

### 2.3 行程详情表（plan_details）

**表名**: plan_details

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `UUID` | `PRIMARY KEY DEFAULT gen_random_uuid()` | 详情ID |
| `plan_id` | `UUID` | `REFERENCES travel_plans(id) NOT NULL` | 所属计划ID |
| `day_number` | `INTEGER` | `NOT NULL` | 第几天 |
| `activity_type` | `VARCHAR(50)` | `NOT NULL` | 活动类型（transport/accommodation/attraction/restaurant） |
| `title` | `VARCHAR(100)` | `NOT NULL` | 活动标题 |
| `description` | `TEXT` | `NULL` | 活动描述 |
| `location` | `VARCHAR(255)` | `NULL` | 地点 |
| `start_time` | `TIME` | `NULL` | 开始时间 |
| `end_time` | `TIME` | `NULL` | 结束时间 |
| `cost` | `DECIMAL(10,2)` | `DEFAULT 0` | 费用 |
| `image_url` | `VARCHAR(255)` | `NULL` | 图片URL |
| `sort_order` | `INTEGER` | `DEFAULT 0` | 排序顺序 |
| `created_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |

### 2.4 费用记录表（expenses）

**表名**: expenses

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `UUID` | `PRIMARY KEY DEFAULT gen_random_uuid()` | 费用ID |
| `plan_id` | `UUID` | `REFERENCES travel_plans(id) NOT NULL` | 所属计划ID |
| `category` | `VARCHAR(50)` | `NOT NULL` | 费用类别（transport/accommodation/food/attraction/shopping/other） |
| `amount` | `DECIMAL(10,2)` | `NOT NULL` | 金额 |
| `description` | `VARCHAR(255)` | `NULL` | 描述 |
| `expense_date` | `DATE` | `DEFAULT CURRENT_DATE` | 消费日期 |
| `payment_method` | `VARCHAR(50)` | `NULL` | 支付方式 |
| `created_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |

### 2.5 用户偏好表（user_preferences）

**表名**: user_preferences

| 字段名 | 数据类型 | 约束 | 描述 |
| :--- | :--- | :--- | :--- |
| `id` | `UUID` | `PRIMARY KEY DEFAULT gen_random_uuid()` | 偏好ID |
| `user_id` | `UUID` | `REFERENCES users(id) UNIQUE NOT NULL` | 所属用户ID |
| `preferred_destinations` | `TEXT[]` | `NULL` | 偏好目的地（数组类型） |
| `travel_style` | `TEXT[]` | `NULL` | 旅行风格（美食/购物/文化/自然等，数组类型） |
| `accommodation_preference` | `VARCHAR(50)` | `NULL` | 住宿偏好（hotel/hostel/apartment等） |
| `food_preferences` | `TEXT[]` | `NULL` | 饮食偏好（数组类型） |
| `avoid_items` | `TEXT[]` | `NULL` | 避免项（数组类型） |
| `updated_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 更新时间 |

## 三、关系图

```
                       ┌───────────────┐
                       │    users      │
                       └───────┬───────┘
                               │
                               │ 1:N
                               ▼
┌───────────────────────┐     ┌───────────────┐     ┌─────────────────┐
│  user_preferences     │◄────┤ travel_plans  │◄────┤      expenses   │
└───────────────────────┘     └───────┬───────┘     └─────────────────┘
                                      │
                                      │ 1:N
                                      ▼
                              ┌───────────────┐
                              │  plan_details │
                              └───────────────┘
```

## 四、RLS策略设计

为确保数据安全，需要在Supabase中配置适当的行级安全策略：

### 4.1 用户表RLS策略

```sql
-- 启用RLS
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- 创建策略
CREATE POLICY "用户只能查看自己的信息" ON users 
  FOR SELECT 
  TO authenticated 
  USING (auth.uid() = id);

CREATE POLICY "用户只能更新自己的信息" ON users 
  FOR UPDATE 
  TO authenticated 
  USING (auth.uid() = id);
```

### 4.2 旅行计划表RLS策略

```sql
-- 启用RLS
ALTER TABLE travel_plans ENABLE ROW LEVEL SECURITY;

-- 创建策略
CREATE POLICY "用户只能查看自己的计划" ON travel_plans 
  FOR SELECT 
  TO authenticated 
  USING (user_id = auth.uid());

CREATE POLICY "用户只能创建自己的计划" ON travel_plans 
  FOR INSERT 
  TO authenticated 
  WITH CHECK (user_id = auth.uid());

CREATE POLICY "用户只能更新自己的计划" ON travel_plans 
  FOR UPDATE 
  TO authenticated 
  USING (user_id = auth.uid());

CREATE POLICY "用户只能删除自己的计划" ON travel_plans 
  FOR DELETE 
  TO authenticated 
  USING (user_id = auth.uid());
```

### 4.3 其他表的RLS策略

对于行程详情表和费用记录表，需要确保用户只能访问与自己的旅行计划相关的记录。可以通过关联travel_plans表的user_id来实现。

## 五、索引设计

为提高查询性能，建议在以下字段上创建索引：

1. `users.username` - 唯一索引，用于快速查找用户
2. `users.email` - 唯一索引，用于登录验证
3. `travel_plans.user_id` - 普通索引，用于查询用户的所有计划
4. `plan_details.plan_id` - 普通索引，用于查询计划的所有详情
5. `expenses.plan_id` - 普通索引，用于查询计划的所有费用

## 六、数据迁移注意事项

1. 首次创建表时，需要确保正确设置外键约束
2. 启用RLS前，确保已有正确的策略配置
3. 生产环境中应该先在测试环境验证数据迁移
